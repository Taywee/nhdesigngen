<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      width: 2em;
      height: 2em;
      text-align: center;
    }
  </style>
  <body>
    <script type="module">
      import init, { design_new, design_palette, design_load_palette, design_optimize_palette } from './pkg/nhdesigngen.js';

      async function run() {
        await init();

        const design = design_new();

        // Update the entire interface
        function update() {
          const palette = design_palette(design);

          // Clear out the palette table
          const palette_table = document.getElementById('palette');
          palette_table.textContent = '';
          const index_row = document.createElement('tr');
          const color_row = document.createElement('tr');
          const hue_row = document.createElement('tr');
          const saturation_row = document.createElement('tr');
          const value_row = document.createElement('tr');

          palette_table.appendChild(index_row);
          palette_table.appendChild(color_row);
          palette_table.appendChild(hue_row);
          palette_table.appendChild(saturation_row);
          palette_table.appendChild(value_row);

          const index_th = document.createElement('th');
          index_th.textContent = 'index';
          index_row.appendChild(index_th);

          const color_th = document.createElement('th');
          color_th.textContent = 'color';
          color_row.appendChild(color_th);

          const hue_th = document.createElement('th');
          hue_th.textContent = 'hue';
          hue_row.appendChild(hue_th);

          const saturation_th = document.createElement('th');
          saturation_th.textContent = 'saturation';
          saturation_row.appendChild(saturation_th);

          const value_th = document.createElement('th');
          value_th.textContent = 'value';
          value_row.appendChild(value_th);

          // Actually add the palette
          palette.forEach((item, index) => {
            const index_td = document.createElement('th');
            index_td.textContent = index + 1;
            index_row.appendChild(index_td);

            const color_td = document.createElement('td');
            color_td.setAttribute('style', `background-color: rgba(${item.r}, ${item.g}, ${item.b}, ${item.a});`);
            color_row.appendChild(color_td);

            if (item.a !== 0) {
              const hue_td = document.createElement('td');
              hue_td.textContent = item.h;
              hue_row.appendChild(hue_td);

              const saturation_td = document.createElement('td');
              saturation_td.textContent = item.s;
              saturation_row.appendChild(saturation_td);

              const value_td = document.createElement('td');
              value_td.textContent = item.v;
              value_row.appendChild(value_td);
            }
          });
        }


        // Get a promise for reading the file
        function loadFile(file) {
          return new Promise(resolve => {
            const reader = new FileReader();
            const type = file.type;
            reader.onload = (event) => {
              // Draw the image onto a canvas
              const data = new Uint8Array(event.target.result);
              const blob = new Blob([data], {'type': type});
              const object_url = URL.createObjectURL(blob);
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imgData = Array.from(ctx.getImageData(0, 0, img.width, img.height).data);
                const output = [];
                for (let i = 0; i < imgData.length; i += 4) {
                  output.push([imgData[i], imgData[i + 1], imgData[i + 2], imgData[i + 3]]);
                }
                // Return the canvas rgba data
                resolve(output);
              }
              img.src = object_url;
            };
            reader.readAsArrayBuffer(file);
          });
        }

        function optimizePalette() {
          const optimizer = document.getElementById('optimizer').value;
          design_optimize_palette(design, optimizer);
        }

        async function setPaletteFiles(event) {
          // Load all the files into data
          const data = await Promise.all(Array.from(event.target.files).map(file => loadFile(file)));
          design_load_palette(design, data);
          optimizePalette();
          update();
        }

        function changeOptimizer(event) {
          optimizePalette();
          update();
        }

        document.getElementById('loadpalette').addEventListener('change', setPaletteFiles, false);
        document.getElementById('optimizer').addEventListener('change', changeOptimizer, false);

        update();
      }

      run();
    </script>
    <h1>Palette</h1>
    <label for="optimizer">Palette Optimizer</label>
    <select id="optimizer">
      <option value="kmeans" selected>K-Means</option>
      <option value="weightedkmeans">Weighted K-Means</option>
    </select>
    <br>
    <label for="loadpalette">Load Palette Image(s)</label>
    <input type="file" id="loadpalette" name="files[]" multiple />
    <table id="palette"></table>
  </body>
</html>
